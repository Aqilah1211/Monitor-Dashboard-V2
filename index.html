<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IFP Monitoring Multi-Sheet</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; }
        .glass-card { background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(10px); border: 1px solid rgba(226, 232, 240, 0.8); }
        .sidebar-item-active { background-color: #eff6ff; color: #2563eb; border-right: 4px solid #2563eb; }
        .loader { border: 2px solid #f3f3f3; border-radius: 50%; border-top: 2px solid #2563eb; width: 20px; height: 20px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .animate-fade-in { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="text-slate-800">

    <!-- Sidebar -->
    <aside class="fixed left-0 top-0 h-full w-20 md:w-64 bg-white border-r border-slate-200 flex flex-col z-50 transition-all">
        <div class="p-6 flex items-center gap-3 border-b border-slate-50">
            <div class="w-10 h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-200">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 14a1 1 0 00-1 1v2a1 1 0 001 1h10a1 1 0 001-1v-2a1 1 0 00-1-1H7zM4 3a2 2 0 00-2 2v6a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4z" />
                </svg>
            </div>
            <span class="hidden md:block font-bold text-xl tracking-tight text-slate-800">IFP Dashboard</span>
        </div>
        
        <nav class="flex-1 py-6 space-y-1">
            <button onclick="switchTab('overview')" id="nav-overview" class="w-full flex items-center gap-4 px-6 py-3 text-slate-500 hover:bg-slate-50 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" /></svg>
                <span class="hidden md:block font-semibold">Overview</span>
            </button>
            <button onclick="switchTab('trouble')" id="nav-trouble" class="w-full flex items-center gap-4 px-6 py-3 text-slate-500 hover:bg-slate-50 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                <span class="hidden md:block font-semibold">Troubles</span>
            </button>
            <button onclick="switchTab('installed')" id="nav-installed" class="w-full flex items-center gap-4 px-6 py-3 text-slate-500 hover:bg-slate-50 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="hidden md:block font-semibold">Installed</span>
            </button>
            <button onclick="switchTab('pending')" id="nav-pending" class="w-full flex items-center gap-4 px-6 py-3 text-slate-500 hover:bg-slate-50 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-9-9" /></svg>
                <span class="hidden md:block font-semibold">Pending</span>
            </button>
            <button onclick="switchTab('settings')" id="nav-settings" class="w-full flex items-center gap-4 px-6 py-3 text-slate-500 hover:bg-slate-50 transition-all">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>
                <span class="hidden md:block font-semibold">Settings</span>
            </button>
        </nav>

        <div class="p-4 border-t border-slate-100">
            <div id="connection-status" class="flex items-center gap-2 px-3 py-2 bg-emerald-50 rounded-lg">
                <div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div>
                <span class="text-[10px] font-bold text-emerald-600 uppercase text-center">Live Sync On</span>
            </div>
        </div>
    </aside>

    <!-- Content Area -->
    <main class="ml-20 md:ml-64 p-4 md:p-8 transition-all">
        
        <!-- Top Header -->
        <header class="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
            <div class="flex flex-col gap-1">
                <!-- Sheet ID Input Form -->
                <div id="sheet-input-section" class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-4" style="display: none;">
                    <label class="block text-sm font-semibold text-slate-700 mb-2">Google Sheet ID (Optional)</label>
                    <div class="flex gap-2">
                        <input type="text" id="sheet-id-input" placeholder="Paste Sheet ID dari URL Google Sheets..." class="flex-1 px-3 py-2 border border-blue-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <button onclick="loadCustomSheet()" class="px-4 py-2 bg-blue-600 text-white rounded-lg font-semibold text-sm hover:bg-blue-700 transition-all">Load</button>
                        <button onclick="toggleSheetInput()" class="px-3 py-2 bg-slate-200 text-slate-700 rounded-lg font-semibold text-sm hover:bg-slate-300 transition-all">Batal</button>
                    </div>
                </div>
                
                <div class="flex items-center gap-3">
                    <h2 id="page-title" class="text-2xl font-bold text-slate-800 leading-none">Dashboard</h2>
                    <select id="sheet-selector" onchange="changeSheet(this.value)" class="bg-blue-50 text-blue-600 font-bold text-xs px-3 py-1.5 rounded-lg border border-blue-100 outline-none hover:bg-blue-100 transition-all cursor-pointer">
                        <!-- Options injected via JS -->
                    </select>
                </div>
                <p class="text-sm text-slate-500">Update terakhir: <span id="last-updated" class="font-medium">-</span></p>
            </div>
            <div class="flex items-center gap-3">
                <button onclick="fetchSheetData()" class="flex items-center gap-2 px-4 py-2 bg-white border border-slate-200 rounded-xl hover:bg-slate-50 transition-all shadow-sm">
                    <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                    <span class="text-sm font-semibold text-slate-600">Sync Now</span>
                </button>
                <button onclick="toggleSheetInput()" class="flex items-center gap-2 px-4 py-2 bg-slate-100 border border-slate-200 rounded-xl hover:bg-slate-150 transition-all shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 text-slate-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4" /></svg>
                    <span class="text-sm font-semibold text-slate-600">Change Sheet</span>
                </button>
            </div>
        </header>

        <!-- Stats Grid -->
        <div id="stats-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
            <!-- Stats items same as before -->
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-l-blue-500">
                <div class="flex items-center justify-between mb-2 text-slate-400">
                    <span class="text-[10px] font-bold uppercase tracking-wider">Total Unit</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" /></svg>
                </div>
                <h3 id="total-unit" class="text-3xl font-bold text-slate-800">0</h3>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-l-emerald-500">
                <div class="flex items-center justify-between mb-2 text-slate-400">
                    <span class="text-[10px] font-bold uppercase tracking-wider">Terpasang</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                </div>
                <h3 id="count-installed" class="text-3xl font-bold text-emerald-600">0</h3>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-l-amber-500">
                <div class="flex items-center justify-between mb-2 text-slate-400">
                    <span class="text-[10px] font-bold uppercase tracking-wider">Pending</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-9-9" /></svg>
                </div>
                <h3 id="count-pending" class="text-3xl font-bold text-amber-500">0</h3>
            </div>
            <div class="glass-card p-6 rounded-2xl shadow-sm border-l-4 border-l-rose-500">
                <div class="flex items-center justify-between mb-2 text-slate-400">
                    <span class="text-[10px] font-bold uppercase tracking-wider">Kendala</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" /></svg>
                </div>
                <h3 id="count-trouble" class="text-3xl font-bold text-rose-600">0</h3>
            </div>
        </div>

        <!-- Overview Content -->
        <div id="overview-section" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <div class="lg:col-span-2 glass-card p-6 rounded-3xl shadow-sm">
                <h3 class="font-bold text-lg mb-6">Tren Progres Pemasangan</h3>
                <div class="h-[300px] w-full">
                    <canvas id="progressChart"></canvas>
                </div>
            </div>
            <div class="glass-card p-6 rounded-3xl shadow-sm flex flex-col">
                <h3 class="font-bold text-lg mb-4 flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-amber-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                    Aktifitas Terbaru
                </h3>
                <div id="activity-log" class="flex-1 space-y-4 overflow-y-auto max-h-[300px] pr-2 text-sm text-slate-500">
                    <p class="text-center py-10">Menunggu sinkronisasi...</p>
                </div>
            </div>
        </div>

        <!-- Table Sections -->
        <div id="table-container" class="hidden mt-8 glass-card rounded-3xl shadow-sm overflow-hidden">
            <div class="p-6 border-b border-slate-100 flex flex-col gap-4">
                <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                    <h3 id="table-title" class="text-xl font-bold">Data Detail</h3>
                    <div class="flex flex-wrap items-center gap-2 w-full md:w-auto">
                        <div class="flex items-center gap-2 bg-slate-50 px-3 py-1.5 rounded-xl border border-slate-100">
                            <span class="text-[10px] font-bold text-slate-400 uppercase">Filter Tgl:</span>
                            <input type="date" id="dateFilterStart" onchange="applyFilters()" class="bg-transparent text-xs outline-none">
                            <span class="text-slate-300">-</span>
                            <input type="date" id="dateFilterEnd" onchange="applyFilters()" class="bg-transparent text-xs outline-none">
                        </div>
                        <input type="text" id="globalSearch" onkeyup="applyFilters()" placeholder="Cari NPSN atau Nama..." 
                               class="flex-1 md:w-64 px-4 py-2 border border-slate-200 rounded-xl text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                    </div>
                </div>
            </div>
            <div class="overflow-x-auto">
                <table class="w-full text-left">
                    <thead id="table-head" class="bg-slate-50 border-b border-slate-100"></thead>
                    <tbody id="table-body" class="divide-y divide-slate-50 text-sm"></tbody>
                </table>
            </div>
            <div id="no-results" class="hidden py-20 text-center text-slate-400">Data tidak ditemukan.</div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="hidden mt-8 glass-card p-8 rounded-3xl shadow-sm max-w-2xl">
            <h3 class="text-xl font-bold mb-2">Pengaturan Data</h3>
            <p class="text-slate-500 text-sm mb-6">Ubah ID Spreadsheet dan kelola daftar Sheet (tab).</p>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Spreadsheet ID</label>
                    <input type="text" id="input-spreadsheet-id" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="ID dari URL spreadsheet...">
                </div>
                <div>
                    <label class="block text-xs font-bold text-slate-400 uppercase mb-2">Daftar Sheet (Pisahkan dengan koma)</label>
                    <textarea id="input-sheet-list" rows="3" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl outline-none focus:ring-2 focus:ring-blue-500 transition-all" placeholder="Contoh: 5, Rekap, Januari, Februari"></textarea>
                    <p class="text-[10px] text-slate-400 mt-2 italic">*Masukkan nama tab atau GID sheet Anda.</p>
                </div>
                <div class="pt-2 flex gap-3">
                    <button onclick="saveSettings()" class="px-6 py-3 bg-blue-600 text-white font-bold rounded-xl hover:bg-blue-700 transition-all shadow-lg shadow-blue-100">Simpan Perubahan</button>
                    <button onclick="resetSettings()" class="px-6 py-3 bg-slate-100 text-slate-600 font-bold rounded-xl hover:bg-slate-200 transition-all">Gunakan Default</button>
                </div>
            </div>
        </div>

    </main>

    <script>
        // Settings with Multi-Sheet Support
        const DEFAULT_SID = ''; // No default Sheet ID - user must input manually
        const DEFAULT_SHEETS = '5';

        let SPREADSHEET_ID = localStorage.getItem('ifp_sid') || DEFAULT_SID;
        let SHEET_LIST = SPREADSHEET_ID ? (localStorage.getItem('ifp_sheets') || DEFAULT_SHEETS).split(',').map(s => s.trim()) : [];
        let CURRENT_SHEET = SHEET_LIST.length > 0 ? SHEET_LIST[0] : null;

        let masterData = [];
        let installedData = [];
        let pendingData = [];
        let troubleData = [];
        let currentTab = 'overview';
        let chartInstance = null;

        function updateSheetSelectorUI() {
            const selector = document.getElementById('sheet-selector');
            selector.innerHTML = SHEET_LIST.map(s => `<option value="${s}" ${s === CURRENT_SHEET ? 'selected' : ''}>Tab: ${s}</option>`).join('');
        }

        function changeSheet(val) {
            CURRENT_SHEET = val;
            logActivity(`Pindah ke sheet: ${val}`);
            fetchSheetData();
        }

        function saveSettings() {
            const sid = document.getElementById('input-spreadsheet-id').value.trim();
            const sheets = document.getElementById('input-sheet-list').value.trim();
            
            if (!sid || !sheets) return alert("Data tidak boleh kosong!");
            
            localStorage.setItem('ifp_sid', sid);
            localStorage.setItem('ifp_sheets', sheets);
            location.reload();
        }

        function resetSettings() {
            localStorage.removeItem('ifp_sid');
            localStorage.removeItem('ifp_sheets');
            location.reload();
        }

        async function fetchSheetData() {
            const refreshIcon = document.getElementById('refresh-icon');
            const statusDiv = document.getElementById('connection-status');
            const API_URL = `https://docs.google.com/spreadsheets/d/${SPREADSHEET_ID}/gviz/tq?tqx=out:csv&sheet=${CURRENT_SHEET}`;
            
            refreshIcon.classList.add('animate-spin');
            statusDiv.innerHTML = `<div class="loader"></div><span class="text-[10px] font-bold text-blue-600 uppercase tracking-tight">Syncing...</span>`;

            try {
                const response = await fetch(API_URL);
                if (!response.ok) throw new Error("Akses Ditolak");
                const csvData = await response.text();
                const rows = csvData.split('\n').map(row => {
                    return row.split(/,(?=(?:[^\"]*\"[^\"]*\")*[^\"]*$)/).map(cell => cell.replace(/^"|"$/g, '').trim());
                });

                processData(rows);
                updateDashboardUI();
                logActivity(`Data tab "${CURRENT_SHEET}" berhasil dimuat.`);
                
                statusDiv.innerHTML = `<div class="w-2 h-2 bg-emerald-500 rounded-full animate-pulse"></div><span class="text-[10px] font-bold text-emerald-600 uppercase">Live Sync On</span>`;
            } catch (error) {
                console.error(error);
                logActivity(`Gagal muat sheet "${CURRENT_SHEET}"!`, "error");
                statusDiv.innerHTML = `<div class="w-2 h-2 bg-rose-500 rounded-full"></div><span class="text-[10px] font-bold text-rose-600 uppercase text-center leading-none">Error</span>`;
            } finally {
                refreshIcon.classList.remove('animate-spin');
                document.getElementById('last-updated').innerText = new Date().toLocaleTimeString();
            }
        }

        function processData(rows) {
            installedData = []; pendingData = []; troubleData = [];
            
            for (let i = 1; i < rows.length; i++) {
                const row = rows[i];
                if (!row || !row[3]) continue; 

                const item = {
                    npsn: row[3],
                    nama: row[8],
                    direktorat: row[1],
                    tanggal: row[19] || "",
                    status: (row[20] || "").toLowerCase(),
                    kendala: row[21] || ""
                };

                if (item.status.includes('selesai')) installedData.push(item);
                else pendingData.push(item);

                if (item.kendala.length > 2) troubleData.push(item);
            }
            masterData = rows;
        }

        function updateDashboardUI() {
            document.getElementById('total-unit').innerText = Math.max(0, masterData.length - 1);
            document.getElementById('count-installed').innerText = installedData.length;
            document.getElementById('count-pending').innerText = pendingData.length;
            document.getElementById('count-trouble').innerText = troubleData.length;

            updateChart();
            if (currentTab !== 'overview' && currentTab !== 'settings') renderTable(currentTab);
        }

        function updateChart() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();

            const total = masterData.length - 1;
            const percentage = total > 0 ? (installedData.length / total * 100).toFixed(1) : 0;

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Target', 'Selesai'],
                    datasets: [{
                        label: 'Progres (%)',
                        data: [100, percentage],
                        borderColor: '#2563eb',
                        backgroundColor: 'rgba(37, 99, 235, 0.1)',
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#fff',
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true, max: 100 } }
                }
            });
        }

        function switchTab(tab) {
            currentTab = tab;
            const title = document.getElementById('page-title');
            const sections = {
                overview: document.getElementById('overview-section'),
                table: document.getElementById('table-container'),
                settings: document.getElementById('settings-section'),
                stats: document.getElementById('stats-grid')
            };
            
            ['overview', 'trouble', 'installed', 'pending', 'settings'].forEach(t => {
                document.getElementById(`nav-${t}`).classList.remove('sidebar-item-active');
            });
            document.getElementById(`nav-${tab}`).classList.add('sidebar-item-active');

            Object.values(sections).forEach(s => s.classList.add('hidden'));

            if (tab === 'overview') {
                sections.overview.classList.remove('hidden');
                sections.stats.classList.remove('hidden');
                title.innerText = "Dashboard Utama";
            } else if (tab === 'settings') {
                sections.settings.classList.remove('hidden');
                title.innerText = "Pengaturan";
                document.getElementById('input-spreadsheet-id').value = SPREADSHEET_ID;
                document.getElementById('input-sheet-list').value = SHEET_LIST.join(', ');
            } else {
                sections.table.classList.remove('hidden');
                sections.stats.classList.remove('hidden');
                renderTable(tab);
            }
        }

        function renderTable(type) {
            const head = document.getElementById('table-head');
            const title = document.getElementById('table-title');
            const commonHead = `<th class="px-6 py-4 text-center w-16 text-[10px] font-bold text-slate-400 uppercase">#</th>`;

            if (type === 'trouble') {
                title.innerText = "Daftar Kendala";
                head.innerHTML = `<tr>${commonHead}<th>NPSN</th><th>Sekolah</th><th>Detail Kendala</th></tr>`;
            } else if (type === 'installed') {
                title.innerText = "Sekolah Terpasang";
                head.innerHTML = `<tr>${commonHead}<th>NPSN</th><th>Sekolah</th><th>Tanggal</th></tr>`;
            } else if (type === 'pending') {
                title.innerText = "Sekolah Pending";
                head.innerHTML = `<tr>${commonHead}<th>NPSN</th><th>Sekolah</th><th>Direktorat</th></tr>`;
            }
            applyFilters();
        }

        function applyFilters() {
            const body = document.getElementById('table-body');
            const searchVal = document.getElementById('globalSearch').value.toLowerCase();
            const dateStart = document.getElementById('dateFilterStart').value;
            const dateEnd = document.getElementById('dateFilterEnd').value;
            
            let source = currentTab === 'trouble' ? troubleData : currentTab === 'installed' ? installedData : pendingData;
            let htmlBody = '';
            let count = 0;

            source.forEach(item => {
                const matchesSearch = item.npsn.includes(searchVal) || item.nama.toLowerCase().includes(searchVal);
                let matchesDate = true;
                if (dateStart || dateEnd) {
                    const d = parseDate(item.tanggal);
                    if (d) {
                        if (dateStart && d < new Date(dateStart)) matchesDate = false;
                        if (dateEnd && d > new Date(dateEnd)) matchesDate = false;
                    } else matchesDate = false;
                }

                if (matchesSearch && matchesDate) {
                    count++;
                    htmlBody += `<tr class="hover:bg-slate-50 transition-all">
                        <td class="px-6 py-4 text-center font-bold text-slate-300">${count}</td>
                        <td class="px-6 py-4 font-mono text-blue-600 font-bold">${item.npsn}</td>
                        <td class="px-6 py-4 font-semibold text-slate-700">${item.nama}</td>
                        <td class="px-6 py-4">
                            ${currentTab === 'trouble' ? `<span class="bg-rose-50 text-rose-600 px-3 py-1 rounded-lg text-xs font-bold border border-rose-100">${item.kendala}</span>` : 
                              currentTab === 'installed' ? `<span class="text-emerald-600 font-bold">${item.tanggal}</span>` : 
                              `<span class="text-slate-500">${item.direktorat}</span>`}
                        </td>
                    </tr>`;
                }
            });
            body.innerHTML = htmlBody;
            document.getElementById('no-results').classList.toggle('hidden', count > 0);
        }

        function parseDate(s) {
            if (!s) return null;
            if (s.includes('/')) {
                const p = s.split('/');
                return new Date(p[2], p[1]-1, p[0]);
            }
            return new Date(s);
        }

        function logActivity(msg, type = "info") {
            const log = document.getElementById('activity-log');
            if (log.innerText.includes("Menunggu")) log.innerHTML = "";
            const div = document.createElement('div');
            div.className = `p-3 rounded-xl border-l-4 mb-2 animate-fade-in ${type === 'info' ? 'bg-blue-50 border-l-blue-400' : 'bg-rose-50 border-l-rose-400'}`;
            div.innerHTML = `<p class="font-bold text-xs">${msg}</p><span class="text-[9px] text-slate-400">${new Date().toLocaleTimeString()}</span>`;
            log.prepend(div);
        }

        function toggleSheetInput() {
            const section = document.getElementById('sheet-input-section');
            if (section.style.display === 'none') {
                section.style.display = 'block';
                document.getElementById('sheet-id-input').focus();
            } else {
                section.style.display = 'none';
            }
        }

        function loadCustomSheet() {
            const newSheetId = document.getElementById('sheet-id-input').value.trim();
            
            if (!newSheetId) {
                alert('Mohon masukkan Sheet ID');
                return;
            }
            
            // Extract Sheet ID from Google Sheets URL if user pasted full URL
            let extractedId = newSheetId;
            const urlMatch = newSheetId.match(/\/d\/([a-zA-Z0-9-_]+)/);
            if (urlMatch) {
                extractedId = urlMatch[1];
            }
            
            SPREADSHEET_ID = extractedId;
            localStorage.setItem('ifp_sid', extractedId);
            
            logActivity(`Sheet ID changed: ${extractedId.substring(0, 10)}...`, 'info');
            toggleSheetInput();
            
            // Reset and reload
            SHEET_LIST = DEFAULT_SHEETS.split(',').map(s => s.trim());
            CURRENT_SHEET = SHEET_LIST[0];
            updateSheetSelectorUI();
            fetchSheetData();
        }

        window.onload = () => {
            if (!SPREADSHEET_ID) {
                logActivity('Mohon input Google Sheet ID untuk memulai', 'info');
                toggleSheetInput();
            } else {
                updateSheetSelectorUI();
                fetchSheetData();
            }
            switchTab('overview');
        };
    </script>
</body>
</html>
